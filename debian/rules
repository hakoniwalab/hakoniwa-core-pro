#!/usr/bin/make -f

# 並列ビルド数
export DEB_BUILD_OPTIONS = parallel=$(shell nproc)

# 必要ならここでビルド用の環境変数を固定
# 例: export ASSET_NUM=8
# 例: export ENABLE_HAKO_TIME_MEASURE_FLAG=-DENABLE_HAKO_TIME_MEASURE=ON

%:
	dh $@ --buildsystem=cmake --builddirectory=cmake-build --with python3



# CMakeの自動configureは使わず、あなたのスクリプトで実行
override_dh_auto_configure:
	chmod +x ./build.bash
	mkdir -p cmake-build
	ASSET_NUM="$(ASSET_NUM)" ENABLE_HAKO_TIME_MEASURE_FLAG="$(ENABLE_HAKO_TIME_MEASURE_FLAG)" \
	BUILD_C_FLAGS="-DHAKO_CLIENT_OPTION_FILEPATH=./cmake-options/default-cmake-options.cmake -DCMAKE_SKIP_RPATH=ON" \
		./build.bash

# build もスクリプトに任せる（再ビルド）
override_dh_auto_build:
	ASSET_NUM="$(ASSET_NUM)" ENABLE_HAKO_TIME_MEASURE_FLAG="$(ENABLE_HAKO_TIME_MEASURE_FLAG)" \
		./build.bash
	


# clean はスクリプトの「引数あり＝クリーン」分岐を利用
override_dh_auto_clean:
	rm -rf obj-* cmake-build CMakeFiles CMakeCache.txt

	./build.bash clean || true
	# 念のため
	rm -rf cmake-build

override_dh_auto_test:
	# CTestは回さない（プロジェクトでテスト未定義のため）
	true


# .install に任せる
#override_dh_auto_install:
#	true

override_dh_clean:
	rm -rf obj-* cmake-build CMakeFiles CMakeCache.txt
	dh_clean

override_dh_installman:
	help2man -N -n "Hakoniwa command-line tool" \
	 -o debian/hako-cmd.1 ./cmake-build/sources/command/hako-cmd
	dh_installman debian/hako-cmd.1

# strip しない
override_dh_strip:

override_dh_missing:
	dh_missing --list-missing

# debian/rules
override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--warnings=0

# python3-hakopy/rules
override_dh_python3:
	dh_python3 --no-ext-rename

# 例: debian/rules
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

OUT := $(CURDIR)/dist
override_dh_builddeb:
	mkdir -p $(OUT)
	dh_builddeb --destdir=$(OUT)
	ln -sf $(OUT)/*.deb ..
